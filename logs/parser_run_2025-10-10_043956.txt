[LOG_START] Parser debug capture started (2025-10-10_043956)
>>> Building chunks (input chars=118)
>>> Built 1 chunks
>>> Starting chunk 1/1 (approx tokens=31)
>>> Calling OpenAI…
[progress] chunk=1, tokens=31, est_seconds=100.0, steps=100, per_step=1.000, start=0, target=100
>>> OpenAI responded in 16469 ms (chars=369)
>>> Got response (chars=369)

===== [EOD][CHUNK_TEXT] LAST CHUNK INPUT BEGIN =====
“You're mine,” he whispered. "You're mine." he whispered. "You're mine", he whispered. 'You're mine,' he whispered.
===== [EOD][CHUNK_TEXT] LAST CHUNK INPUT END =====


===== [EOD][OPENAI_RAW] LAST CHUNK RAW BEGIN (first 60 lines) =====
01: {"character":"He","emotions":["soft","breathless"],"text":"You're mine."}
02: {"character":"He","emotions":["soft","breathless"],"text":"You're mine."}
03: {"character":"He","emotions":["soft","breathless"],"text":"You're mine."}
04: {"character":"He","emotions":["soft","breathless"],"text":"You're mine."}
05: {"character":"He","emotions":["soft","breathless"],"text":"You're mine."}
===== [EOD][OPENAI_RAW] LAST CHUNK RAW END =====

>>> Parsed 5 items
[DIAG][SIM] missing segment detected by token similarity (no match ≥0.6): 'you're mine," he whispered.'
[DIAG][SIM] missing segment detected by token similarity (no match ≥0.6): 'you're mine", he whispered.'
[DIAG][SIM] missing segment detected by token similarity (no match ≥0.6): 'you're mine,' he whispered.'
[DIAG] detect_missing_or_rejected_lines() received 5 lines with 0 REJECTED
[DEBUG] Detection: missing_groups=2 rejected_mapped=0 (total=2)
[DEBUG] Fallback overlap filtered: 0 skipped (REJECTED kept 0)
[DEBUG] Fallback detection: 2 segment(s) found

----- [EOD][FB] Segment DETECTED (last chunk) -----
[EOD][FB] seg#1 kind=missing start_idx=0 end_idx=0
[EOD][FB] segment_text (first 300): “You're mine,” he whispered.
[DIAG] Known chars before fallback: ['Adam (Family)', 'Adam (Supporting)', 'Adam Stone', 'Alexandra', 'Allison', 'Arabella', 'Aria', 'Astro', 'Boyd', 'Brad', 'Brian', 'Brittney', 'Burt Reynolds', 'Carter', 'Christian', 'Clara', 'Clara (Secondary)', 'Cornelius', 'Dad', 'Dante']
[DIAG] Last speaker: He
[DIAG] Fallback segment text (len=28): “You're mine,” he whispered.
[DIAG] Passing known_characters to fallback: True
[DEBUG] Frendli token loaded: True
[DEBUG] FRIENDLI_TOKEN found: True
[DEBUG] Friendli client base_url: https://api.friendli.ai/serverless/v1/
[DEBUG] Frendli request URL verified
[DIAG] Friendli system prompt (first 12 lines):
[DIAG]   01: You are a strict audiobook dialogue parser.
[DIAG]   02: Output MUST be JSON Lines (JSONL). One JSON object per line with keys: character, emotions (2 strings), text. Optional: candidates (2–5 strings) only when character == 'Ambiguous'.
[DIAG]   03: No extra text, no commentary, no blank lines.
[DIAG]   04: Do NOT invent new character names under any circumstances.
[DIAG]   05: If the speaker is unclear, use 'Ambiguous' and choose candidates ONLY from Known characters.
[DIAG]   06: Coverage: Do NOT skip any input sentence.
[DIAG]   07: If speaker unclear → use 'Ambiguous' with 2–5 candidates from known characters.
[DIAG]   08: Narration: Use 'Narrator' for objective, third-person description (not tied to any POV).
[DIAG]   09: Quotes: The text field must contain ONLY the spoken words inside quotes (drop attributions like 'he growled').
[DIAG]   10: When quotes include attribution verbs (e.g., said, asked, whispered, commanded, moaned, murmured, replied), exclude those verbs from the 'text' (keep only the words inside quotes).
[DIAG]   11: Speaker inference: When a quoted dialogue appears after a character’s name or pronoun (e.g., Mark said, '…' or he whispered, '…'), infer that character as the speaker of the quoted text.
[DIAG]   12: Emotions: Exactly TWO per line; if none, use ['neutral','calm'].
[DIAG] Known characters empty: False; Has 'Do NOT invent names' clause: True
[DEBUG] Frendli request begin
[DEBUG] Frendli request end (1594 ms, chars=80)
[DEBUG] Fallback raw returned length=80
----- [EOD][FB] RAW Friendli OUT (first 30 lines) -----
01: {"character":"Adam Stone","emotions":["possessive","calm"],"text":"You're mine"}
[DIAG] Fallback RAW (first 2 lines): ['{"character":"Adam Stone","emotions":["possessive","calm"],"text":"You\'re mine"}']
[DEBUG] Fallback parsed 1 line(s)
[DEBUG] Fallback error ignored: cannot access local variable '_extract_quotes' where it is not associated with a value

----- [EOD][FB] Segment DETECTED (last chunk) -----
[EOD][FB] seg#2 kind=missing start_idx=2 end_idx=3
[EOD][FB] segment_text (first 300): "You're mine", he whispered.
'You're mine,' he whispered.
[DIAG] Known chars before fallback: ['Adam (Family)', 'Adam (Supporting)', 'Adam Stone', 'Alexandra', 'Allison', 'Arabella', 'Aria', 'Astro', 'Boyd', 'Brad', 'Brian', 'Brittney', 'Burt Reynolds', 'Carter', 'Christian', 'Clara', 'Clara (Secondary)', 'Cornelius', 'Dad', 'Dante']
[DIAG] Last speaker: Adam Stone
[DIAG] Fallback segment text (len=57): "You're mine", he whispered.
'You're mine,' he whispered.
[DIAG] Passing known_characters to fallback: True
[DEBUG] Frendli token loaded: True
[DEBUG] FRIENDLI_TOKEN found: True
[DEBUG] Friendli client base_url: https://api.friendli.ai/serverless/v1/
[DEBUG] Frendli request URL verified
[DIAG] Friendli system prompt (first 12 lines):
[DIAG]   01: You are a strict audiobook dialogue parser.
[DIAG]   02: Output MUST be JSON Lines (JSONL). One JSON object per line with keys: character, emotions (2 strings), text. Optional: candidates (2–5 strings) only when character == 'Ambiguous'.
[DIAG]   03: No extra text, no commentary, no blank lines.
[DIAG]   04: Do NOT invent new character names under any circumstances.
[DIAG]   05: If the speaker is unclear, use 'Ambiguous' and choose candidates ONLY from Known characters.
[DIAG]   06: Coverage: Do NOT skip any input sentence.
[DIAG]   07: If speaker unclear → use 'Ambiguous' with 2–5 candidates from known characters.
[DIAG]   08: Narration: Use 'Narrator' for objective, third-person description (not tied to any POV).
[DIAG]   09: Quotes: The text field must contain ONLY the spoken words inside quotes (drop attributions like 'he growled').
[DIAG]   10: When quotes include attribution verbs (e.g., said, asked, whispered, commanded, moaned, murmured, replied), exclude those verbs from the 'text' (keep only the words inside quotes).
[DIAG]   11: Speaker inference: When a quoted dialogue appears after a character’s name or pronoun (e.g., Mark said, '…' or he whispered, '…'), infer that character as the speaker of the quoted text.
[DIAG]   12: Emotions: Exactly TWO per line; if none, use ['neutral','calm'].
[DIAG] Known characters empty: False; Has 'Do NOT invent names' clause: True
[DEBUG] Frendli request begin
[DEBUG] Frendli request end (1594 ms, chars=157)
[DEBUG] Fallback raw returned length=157
----- [EOD][FB] RAW Friendli OUT (first 30 lines) -----
01: {"character":"He","emotions":["possessive","arrogant"],"text":"You''re mine."}
02: {"character":"He","emotions":["possessive","arrogant"],"text":"You''re mine."}
[DIAG] Fallback RAW (first 2 lines): ['{"character":"He","emotions":["possessive","arrogant"],"text":"You\'\'re mine."}', '{"character":"He","emotions":["possessive","arrogant"],"text":"You\'\'re mine."}']
[DEBUG] Fallback parsed 2 line(s)
[DEBUG] Fallback error ignored: cannot access local variable '_extract_quotes' where it is not associated with a value
[DIAG] Streaming reinjection: considered=4
[DIAG][REINJECT] (streaming) single-line reinjection enabled (avg_tokens=4.0) span=[0:0]
[DIAG] Streaming reinjected (strict): '“You're mine,” he whispered.' | samples=["You're mine.", "“You're mine,” he whispered."]
[DIAG] Streaming reinjected (strict): '"You're mine", he whispered.' | samples=["You're mine.", "“You're mine,” he whispered."]
[DIAG] Streaming reinjected (strict): ''You're mine,' he whispered.' | samples=["You're mine.", "“You're mine,” he whispered."]

===== [EOD][TAIL] FINAL RECONCILED LAST 20 LINES (pre-REJECTED-purge/stream) =====
001. [ai] He: You're mine.
002. [reinj] Narrator: “You're mine,” he whispered.
003. [reinj] Narrator: "You're mine", he whispered.
004. [reinj] Narrator: 'You're mine,' he whispered.
===== [EOD][TAIL] END =====

>>> Yielding chunk 1/1: dialogues=4, ambiguities=0
>>> Wrote parser timings/tokens: [16.47 (31)]
